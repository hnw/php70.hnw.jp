<!DOCTYPE html PUBLIC '-//W3C//DTD XHTML 1.0 Transitional//EN' 'http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd'>
<html xmlns='http://www.w3.org/1999/xhtml'>
<head>
<title>ext/phar/stub.h</title>
<meta name='robots' content='noindex,nofollow' />
<meta name='generator' content='GLOBAL-6.5.4' />
<meta http-equiv='Content-Style-Type' content='text/css' />
<link rel='stylesheet' type='text/css' href='../style.css' />
</head>
<body>
<a id='TOP' name='TOP'></a><h2 class='header'><a href='../mains.html'>root</a>/<a href='../files/1743.html'>ext</a>/<a href='../files/1826.html'>phar</a>/stub.h</h2>
<em class='comment'>/* [&lt;][&gt;]<a href='#L21'>[^]</a>[v][top]<a href='#BOTTOM'>[bottom]</a><a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</em>
<hr />
<h2 class='header'><a href='960.html#L2448' title='Included from 2448 in ext/phar/phar.c.'>INCLUDED FROM</a></h2>
<hr />
<h2 class='header'>DEFINITIONS</h2>
This source file includes following definitions.
<ol>
<li><a href='#L21' title='Defined at 21.'>phar_get_stub</a></li>
</ol>
<hr />
<pre>
<a id='L1' name='L1'></a>   1 <em class='comment'>/*</em>
<a id='L2' name='L2'></a>   2 <em class='comment'>  +----------------------------------------------------------------------+</em>
<a id='L3' name='L3'></a>   3 <em class='comment'>  | phar php single-file executable PHP extension generated stub         |</em>
<a id='L4' name='L4'></a>   4 <em class='comment'>  +----------------------------------------------------------------------+</em>
<a id='L5' name='L5'></a>   5 <em class='comment'>  | Copyright (c) 2005-2016 The PHP Group                                |</em>
<a id='L6' name='L6'></a>   6 <em class='comment'>  +----------------------------------------------------------------------+</em>
<a id='L7' name='L7'></a>   7 <em class='comment'>  | This source file is subject to version 3.01 of the PHP license,      |</em>
<a id='L8' name='L8'></a>   8 <em class='comment'>  | that is bundled with this package in the file LICENSE, and is        |</em>
<a id='L9' name='L9'></a>   9 <em class='comment'>  | available through the world-wide-web at the following url:           |</em>
<a id='L10' name='L10'></a>  10 <em class='comment'>  | http://www.php.net/license/3_01.txt.                                 |</em>
<a id='L11' name='L11'></a>  11 <em class='comment'>  | If you did not receive a copy of the PHP license and are unable to   |</em>
<a id='L12' name='L12'></a>  12 <em class='comment'>  | obtain it through the world-wide-web, please send a note to          |</em>
<a id='L13' name='L13'></a>  13 <em class='comment'>  | license@php.net so we can mail you a copy immediately.               |</em>
<a id='L14' name='L14'></a>  14 <em class='comment'>  +----------------------------------------------------------------------+</em>
<a id='L15' name='L15'></a>  15 <em class='comment'>  | Authors: Gregory Beaver &lt;cellog@php.net&gt;                             |</em>
<a id='L16' name='L16'></a>  16 <em class='comment'>  +----------------------------------------------------------------------+</em>
<a id='L17' name='L17'></a>  17 <em class='comment'>*/</em>
<a id='L18' name='L18'></a>  18 
<a id='L19' name='L19'></a>  19 <em class='comment'>/* $Id$ */</em>
<a id='L20' name='L20'></a>  20 
<a id='L21' name='L21'></a>  21 <strong class='reserved'>static</strong> <strong class='reserved'>inline</strong> <a href='../S/1731.html#L87' title='Defined at 87 in Zend/zend_types.h.'>zend_string</a>* <a href='../S/960.html#L2485' title='Referred from 2485 in ext/phar/phar.c.'>phar_get_stub</a>(<strong class='reserved'>const</strong> <strong class='reserved'>char</strong> *<a href='../Y/23111.html' title='Multiple used in 12 places.'>index_php</a>, <strong class='reserved'>const</strong> <strong class='reserved'>char</strong> *<a href='../Y/40671.html' title='Multiple used in 2 places.'>web</a>, <strong class='reserved'>const</strong> <strong class='reserved'>int</strong> <a href='../Y/27946.html' title='Multiple used in 528 places.'>name_len</a>, <strong class='reserved'>const</strong> <strong class='reserved'>int</strong> <a href='../Y/40674.html' title='Multiple used in 7 places.'>web_len</a>)
<a id='L22' name='L22'></a>  22 <em class='brace'>{</em>
<a id='L23' name='L23'></a>  23         <strong class='reserved'>static</strong> <strong class='reserved'>const</strong> <strong class='reserved'>char</strong> <a href='../Y/28431.html' title='Multiple used in 2 places.'>newstub0</a>[] = "&lt;?php\n\n$web = '";
<a id='L24' name='L24'></a>  24         <strong class='reserved'>static</strong> <strong class='reserved'>const</strong> <strong class='reserved'>char</strong> <a href='../Y/28432.html' title='Multiple used in 2 places.'>newstub1_0</a>[] = "';\n\nif (in_array('phar', stream_get_wrappers()) &amp;&amp; class_exists('Phar', 0)) {\nPhar::interceptFileFuncs();\nset_include_path('phar://' . __FILE__ . PATH_SEPARATOR . get_include_path());\nPhar::webPhar(null, $web);\ninclude 'phar://' . __FILE__ . '/' . Extract_Phar::START;\nreturn;\n}\n\nif (@(isset($_SERVER['REQUEST_URI']) &amp;&amp; isset($_SERVER['REQUEST_METHOD']) &amp;&amp; ($_SERVER['REQUEST_METHOD'] == 'GET' || $_SERVER['REQUEST_METHOD'] == 'POST'))) {\nExtract_Phar::go(true);\n$mimes = array(\n'phps' =&gt; 2,\n'c' =&gt; 'text/plain',\n'cc' =&gt; 'text/plain',\n'cpp' =&gt; 'text/plain',\n'c++' =&gt; 'text/plain',\n'dtd' =&gt; 'text/plain',\n'h' =&gt; 'text/plain',\n'log' =&gt; 'text/plain',\n'rng' =&gt; 'text/plain',\n'txt' =&gt; 'text/plain',\n'xsd' =&gt; 'text/plain',\n'php' =&gt; 1,\n'inc' =&gt; 1,\n'avi' =&gt; 'video/avi',\n'bmp' =&gt; 'image/bmp',\n'css' =&gt; 'text/css',\n'gif' =&gt; 'image/gif',\n'htm' =&gt; 'text/html',\n'html' =&gt; 'text/html',\n'htmls' =&gt; 'text/html',\n'ico' =&gt; 'image/x-ico',\n'jpe' =&gt; 'image/jpeg',\n'jpg' =&gt; 'image/jpeg',\n'jpeg' =&gt; 'image/jpeg',\n'js' =&gt; 'application/x-javascript',\n'midi' =&gt; 'audio/midi',\n'mid' =&gt; 'audio/midi',\n'mod' =&gt; 'audio/mod',\n'mov' =&gt; 'movie/quicktime',\n'mp3' =&gt; 'audio/mp3',\n'mpg' =&gt; 'video/mpeg',\n'mpeg' =&gt; 'video/mpeg',\n'pdf' =&gt; 'application/pdf',\n'png' =&gt; 'image/png',\n'swf' =&gt; 'application/shockwave-flash',\n'tif' =&gt; 'image/tiff',\n'tiff' =&gt; 'image/tiff',\n'wav' =&gt; 'audio/wav',\n'xbm' =&gt; 'image/xbm',\n'xml' =&gt; 'text/xml',\n);\n\nheader(\"Cache-Control: no-cache, must-revalidate\");\nheader(\"Pragma: no-cache\");\n\n$basename = basename(__FILE__);\nif (!strpos($_SERVER['REQUEST_URI'], $basename)) {\nchdir(Extract_Phar::$temp);\ninclude $web;\nreturn;\n}\n$pt = substr($_SERVER['REQUEST_URI'], strpos($_SERVER['REQUEST_URI'], $basename) + strlen($basename));\nif (!$pt || $pt == '/') {\n$pt = $web;\nheader('HTTP/1.1 301 Moved Permanently');\nheader('Location: ' . $_SERVER['REQUEST_URI'] . '/' . $pt);\nexit;\n}\n$a = realpath(Extract_Phar::$temp . DIRECTORY_SEPARATOR . $pt);\nif (!$a || strlen(dirname($a)) &lt; strlen(";
<a id='L25' name='L25'></a>  25         <strong class='reserved'>static</strong> <strong class='reserved'>const</strong> <strong class='reserved'>char</strong> <a href='../Y/28433.html' title='Multiple used in 2 places.'>newstub1_1</a>[] = "Extract_Phar::$temp)) {\nheader('HTTP/1.0 404 Not Found');\necho \"&lt;html&gt;\\n &lt;head&gt;\\n  &lt;title&gt;File Not Found&lt;title&gt;\\n &lt;/head&gt;\\n &lt;body&gt;\\n  &lt;h1&gt;404 - File \", $pt, \" Not Found&lt;/h1&gt;\\n &lt;/body&gt;\\n&lt;/html&gt;\";\nexit;\n}\n$b = pathinfo($a);\nif (!isset($b['extension'])) {\nheader('Content-Type: text/plain');\nheader('Content-Length: ' . filesize($a));\nreadfile($a);\nexit;\n}\nif (isset($mimes[$b['extension']])) {\nif ($mimes[$b['extension']] === 1) {\ninclude $a;\nexit;\n}\nif ($mimes[$b['extension']] === 2) {\nhighlight_file($a);\nexit;\n}\nheader('Content-Type: ' .$mimes[$b['extension']]);\nheader('Content-Length: ' . filesize($a));\nreadfile($a);\nexit;\n}\n}\n\nclass Extract_Phar\n{\nstatic $temp;\nstatic $origdir;\nconst GZ = 0x1000;\nconst BZ2 = 0x2000;\nconst MASK = 0x3000;\nconst START = '";
<a id='L26' name='L26'></a>  26         <strong class='reserved'>static</strong> <strong class='reserved'>const</strong> <strong class='reserved'>char</strong> <a href='../Y/28434.html' title='Multiple used in 2 places.'>newstub2</a>[] = "';\nconst LEN = ";
<a id='L27' name='L27'></a>  27         <strong class='reserved'>static</strong> <strong class='reserved'>const</strong> <strong class='reserved'>char</strong> <a href='../Y/28435.html' title='Multiple used in 2 places.'>newstub3_0</a>[] = ";\n\nstatic function go($return = false)\n{\n$fp = fopen(__FILE__, 'rb');\nfseek($fp, self::LEN);\n$L = unpack('V', $a = (binary)fread($fp, 4));\n$m = (binary)'';\n\ndo {\n$read = 8192;\nif ($L[1] - strlen($m) &lt; 8192) {\n$read = $L[1] - strlen($m);\n}\n$last = (binary)fread($fp, $read);\n$m .= $last;\n} while (strlen($last) &amp;&amp; strlen($m) &lt; $L[1]);\n\nif (strlen($m) &lt; $L[1]) {\ndie('ERROR: manifest length read was \"' .\nstrlen($m) .'\" should be \"' .\n$L[1] . '\"');\n}\n\n$info = self::_unpack($m);\n$f = $info['c'];\n\nif ($f &amp; self::GZ) {\nif (!function_exists('gzinflate')) {\ndie('Error: zlib extension is not enabled -' .\n' gzinflate() function needed for zlib-compressed .phars');\n}\n}\n\nif ($f &amp; self::BZ2) {\nif (!function_exists('bzdecompress')) {\ndie('Error: bzip2 extension is not enabled -' .\n' bzdecompress() function needed for bz2-compressed .phars');\n}\n}\n\n$temp = self::tmpdir();\n\nif (!$temp || !is_writable($temp)) {\n$sessionpath = session_save_path();\nif (strpos ($sessionpath, \";\") !== false)\n$sessionpath = substr ($sessionpath, strpos ($sessionpath, \";\")+1);\nif (!file_exists($sessionpath) || !is_dir($sessionpath)) {\ndie('Could not locate temporary directory to extract phar');\n}\n$temp = $sessionpath;\n}\n\n$temp .= '/pharextract/'.basename(__FILE__, '.phar');\nself::$temp = $temp;\nself::$origdir = getcwd();\n@mkdir($temp, 0777, true);\n$temp = realpath($temp);\n\nif (!file_exists($temp . DIRECTORY_SEPARATOR . md5_file(__FILE__))) {\nself::_removeTmpFiles($temp, getcwd());\n@mkdir($temp, 0777, true);\n@file_put_contents($temp . '/' . md5_file(__FILE__), '');\n\nforeach ($info['m'] as $path =&gt; $file) {\n$a = !file_exists(dirname($temp . '/' . $path));\n@mkdir(dirname($temp . '/' . $path), 0777, true);\nclearstatcache();\n\nif ($path[strlen($path) - 1] == '/') {\n@mkdir($temp . '/' . $path, 0777);\n} else {\nfile_put_contents($temp . '/' . $path, self::extractFile($path, $file, $fp));\n@chmod($temp . '/' . $path, 0666);\n}\n}\n}\n\nchdir($temp);\n\nif (!$return) {\ninclude self::ST";
<a id='L28' name='L28'></a>  28         <strong class='reserved'>static</strong> <strong class='reserved'>const</strong> <strong class='reserved'>char</strong> <a href='../Y/28436.html' title='Multiple used in 2 places.'>newstub3_1</a>[] = "ART;\n}\n}\n\nstatic function tmpdir()\n{\nif (strpos(PHP_OS, 'WIN') !== false) {\nif ($var = getenv('TMP') ? getenv('TMP') : getenv('TEMP')) {\nreturn $var;\n}\nif (is_dir('/temp') || mkdir('/temp')) {\nreturn realpath('/temp');\n}\nreturn false;\n}\nif ($var = getenv('TMPDIR')) {\nreturn $var;\n}\nreturn realpath('/tmp');\n}\n\nstatic function _unpack($m)\n{\n$info = unpack('V', substr($m, 0, 4));\n $l = unpack('V', substr($m, 10, 4));\n$m = substr($m, 14 + $l[1]);\n$s = unpack('V', substr($m, 0, 4));\n$o = 0;\n$start = 4 + $s[1];\n$ret['c'] = 0;\n\nfor ($i = 0; $i &lt; $info[1]; $i++) {\n $len = unpack('V', substr($m, $start, 4));\n$start += 4;\n $savepath = substr($m, $start, $len[1]);\n$start += $len[1];\n   $ret['m'][$savepath] = array_values(unpack('Va/Vb/Vc/Vd/Ve/Vf', substr($m, $start, 24)));\n$ret['m'][$savepath][3] = sprintf('%u', $ret['m'][$savepath][3]\n&amp; 0xffffffff);\n$ret['m'][$savepath][7] = $o;\n$o += $ret['m'][$savepath][2];\n$start += 24 + $ret['m'][$savepath][5];\n$ret['c'] |= $ret['m'][$savepath][4] &amp; self::MASK;\n}\nreturn $ret;\n}\n\nstatic function extractFile($path, $entry, $fp)\n{\n$data = '';\n$c = $entry[2];\n\nwhile ($c) {\nif ($c &lt; 8192) {\n$data .= @fread($fp, $c);\n$c = 0;\n} else {\n$c -= 8192;\n$data .= @fread($fp, 8192);\n}\n}\n\nif ($entry[4] &amp; self::GZ) {\n$data = gzinflate($data);\n} elseif ($entry[4] &amp; self::BZ2) {\n$data = bzdecompress($data);\n}\n\nif (strlen($data) != $entry[0]) {\ndie(\"Invalid internal .phar file (size error \" . strlen($data) . \" != \" .\n$stat[7] . \")\");\n}\n\nif ($entry[3] != sprintf(\"%u\", crc32((binary)$data) &amp; 0xffffffff)) {\ndie(\"Invalid internal .phar file (checksum error)\");\n}\n\nreturn $data;\n}\n\nstatic function _removeTmpFiles($temp, $origdir)\n{\nchdir($temp);\n\nforeach (glob('*') as $f) {\nif (file_exists($f)) {\nis_dir($f) ? @rmdir($f) : @unlink($f);\nif (file_exists($f) &amp;&amp; is_dir($f)) {\nself::_removeTmpFiles($f, getcwd());\n}\n}\n}\n\n@rmdir($temp);\nclearstatcache();\nchdir($origdir);\n}\n}\n\nExtract_Phar::go();\n__HALT_COMPIL";
<a id='L29' name='L29'></a>  29         <strong class='reserved'>static</strong> <strong class='reserved'>const</strong> <strong class='reserved'>char</strong> <a href='../Y/28437.html' title='Multiple used in 2 places.'>newstub3_2</a>[] = "ER(); ?&gt;";
<a id='L30' name='L30'></a>  30 
<a id='L31' name='L31'></a>  31         <strong class='reserved'>static</strong> <strong class='reserved'>const</strong> <strong class='reserved'>int</strong> <a href='../Y/28438.html' title='Multiple used in 2 places.'>newstub_len</a> = 6665;
<a id='L32' name='L32'></a>  32 
<a id='L33' name='L33'></a>  33         <strong class='reserved'>return</strong> <a href='../S/1411.html#L896' title='Defined at 896 in main/spprintf.c.'>strpprintf</a>(<a href='../Y/27946.html' title='Multiple used in 528 places.'>name_len</a> + <a href='../Y/40674.html' title='Multiple used in 7 places.'>web_len</a> + <a href='../Y/28438.html' title='Multiple used in 2 places.'>newstub_len</a>, "%s%s%s%s%s%s%d%s%s%s", <a href='../Y/28431.html' title='Multiple used in 2 places.'>newstub0</a>, <a href='../Y/40671.html' title='Multiple used in 2 places.'>web</a>, <a href='../Y/28432.html' title='Multiple used in 2 places.'>newstub1_0</a>, <a href='../Y/28433.html' title='Multiple used in 2 places.'>newstub1_1</a>, <a href='../Y/23111.html' title='Multiple used in 12 places.'>index_php</a>, <a href='../Y/28434.html' title='Multiple used in 2 places.'>newstub2</a>, <a href='../Y/27946.html' title='Multiple used in 528 places.'>name_len</a> + <a href='../Y/40674.html' title='Multiple used in 7 places.'>web_len</a> + <a href='../Y/28438.html' title='Multiple used in 2 places.'>newstub_len</a>, <a href='../Y/28435.html' title='Multiple used in 2 places.'>newstub3_0</a>, <a href='../Y/28436.html' title='Multiple used in 2 places.'>newstub3_1</a>, <a href='../Y/28437.html' title='Multiple used in 2 places.'>newstub3_2</a>);
<a id='L34' name='L34'></a>  34 <em class='brace'>}</em>
</pre>
<hr />
<a id='BOTTOM' name='BOTTOM'></a>
<em class='comment'>/* [&lt;][&gt;][^]<a href='#L21'>[v]</a><a href='#TOP'>[top]</a>[bottom]<a href='../mains.html'>[index]</a><a href='../help.html'>[help]</a> */</em>
</body>
</html>
